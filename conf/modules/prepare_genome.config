/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/


process {

    withName: '.*:PREPARE_GENOME:BWA_INDEX' {
        ext.when    = { !params.bwa_index }
        publishDir  = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/reference" },
            pattern: "bwa",
            enabled: params.save_reference
        ]
    }

    withName: '.*:PREPARE_GENOME:STAR_GENOMEGENERATE' {
        ext.when   = {!params.star_index}
        publishDir = [
            path: { "${params.outdir}/reference" },
            mode: params.publish_dir_mode,
            pattern: "star",
            enabled: params.save_reference
        ]
    }

    withName: '.*:PREPARE_GENOME:MAKE_TRANSCRIPTS_FASTA' {
        ext.when   = {!params.transcript_fasta}
        publishDir = [
            [
                path: { "${params.outdir}/" },
                mode: params.publish_dir_mode,
                pattern: "rsem",
                saveAs: { params.save_reference ? "reference/${it}" : null }
            ],
            [
                path: { "${params.outdir}/" },
                mode: params.publish_dir_mode,
                pattern: "*.transcripts.fa",
                saveAs: { params.save_reference ? "reference/${it}" : null }
            ]
        ]
    }

    withName: '.*:PREPARE_GENOME:GTF_GENE_FILTER' {
        ext.when   = {!params.transcript_fasta}
        publishDir = [
            path: { "${params.outdir}/" },
            mode: params.publish_dir_mode,
            pattern: "*.gtf",
            saveAs: { params.save_reference ? "reference/${it}" : null }
            ]
    }

    withName: '.*:PREPARE_GENOME:CTAT_GENOME_LIB' {
        ext.when   = { params.rna_fusion.contains('star_fusion') && !params.ctat_genome_lib }
        publishDir = [
            path: { "${params.outdir}/reference" },
            mode: params.publish_dir_mode
            ]
    }

    withName: '.*:PREPARE_GENOME:ARRIBA_REF_DOWNLOAD' {
        ext.when   = { (!params.arriba_blacklist || !params.arriba_known_fusions || !params.arriba_protein_domains) }
        publishDir = [
            path: { "${params.outdir}/reference/arriba" },
            mode: params.publish_dir_mode
            ]
    }

}
